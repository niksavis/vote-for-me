<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vote For Me - Simple Voting App</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/shared-styles.css" rel="stylesheet">
    <style>

        .main-content {
            padding-top: 80px; /* Space for fixed nav */
        }
        
        .main-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem 1rem;
            min-height: calc(100vh - 80px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .hero-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 3rem 2.5rem;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 700px;
        }
        
        .hero-card h1 {
            font-size: 2.8rem;
            font-weight: 700;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #ffffff 0%, #e8e8e8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 2.5rem;
            font-weight: 300;
        }
        
        .quick-start {
            margin-bottom: 2.5rem;
            text-align: left;
        }
        
        .quick-start h3 {
            font-size: 1.3rem;
            margin-bottom: 1.5rem;
            text-align: center;
            color: white;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .step-number {
            background: #667eea;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            margin-right: 1rem;
            flex-shrink: 0;
        }
        
        .step span:last-child {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.95rem;
        }
        
        .create-form {
            background: rgba(255, 255, 255, 0.1);
            padding: 2rem;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        .create-form h3 {
            color: white;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .form-floating label {
            color: #666;
        }
        
        .form-control, .form-select {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #333;
        }
        
        .form-control:focus, .form-select:focus {
            background: rgba(255, 255, 255, 0.95);
            border-color: #667eea;
            box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
        }
        
        .form-check-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.95rem;
        }
        
        .form-check-input:checked {
            background-color: #667eea;
            border-color: #667eea;
        }
        
        .form-check-input:focus {
            box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
        }
        
        .btn-primary-custom {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            border-radius: 50px;
            padding: 15px 40px;
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
            width: 100%;
        }
        
        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
            background: linear-gradient(135deg, #32b249 0%, #24d0a1 100%);
            color: white;
        }
        
        .btn-loading {
            pointer-events: none;
            opacity: 0.8;
        }
        
        .btn-loading:hover {
            transform: none !important;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3) !important;
        }
        
        .error-message {
            background: rgba(220, 53, 69, 0.1);
            color: #ff6b6b;
            padding: 1rem;
            border-radius: 10px;
            margin-top: 1rem;
            display: none;
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        
        /* Enhanced Form Layout Styles */
        .form-section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .section-title {
            font-size: 1rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }
        
        .voting-settings {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .setting-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }
        
        .setting-label {
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
        }
        
        .setting-description {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 0.25rem;
        }
        
        @media (max-width: 768px) {
            .main-container {
                padding: 1rem 0.5rem;
                min-height: calc(100vh - 80px);
            }
            
            .hero-card {
                padding: 2rem 1.5rem;
                max-width: 95%;
            }
            
            .hero-card h1 {
                font-size: 2rem;
            }
            
            .create-form {
                padding: 1.5rem;
            }
            
            .form-section {
                padding: 1rem;
            }
            
            .setting-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .setting-label {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile-First Navigation Pane -->
    <nav class="nav-pane" id="navigation">
        <div class="nav-container">
            <a href="/" class="nav-brand">
                <i class="fas fa-vote-yea me-2"></i>
                Vote For Me
            </a>
            
            <button class="nav-toggle" onclick="toggleMobileNav()" aria-label="Toggle navigation">
                <i class="fas fa-bars"></i>
            </button>
            
            <div class="nav-links" id="nav-links">
                <a href="/" class="btn-nav active">
                    <i class="fas fa-home me-1"></i>
                    Home
                </a>
                {% if not is_authenticated %}
                <a href="#" class="btn-nav" onclick="showMySessions()">
                    <i class="fas fa-list me-1"></i>
                    My Sessions
                </a>
                {% endif %}
                {% if is_authenticated %}
                <a href="/admin" class="btn-nav">
                    <i class="fas fa-tachometer-alt me-1"></i>
                    Admin
                </a>
                <a href="/config" class="btn-nav">
                    <i class="fas fa-cog me-1"></i>
                    Config
                </a>
                <a href="/logout" class="btn-nav">
                    <i class="fas fa-sign-out-alt me-1"></i>
                    Logout
                </a>
                {% else %}
                <a href="/login" class="btn-nav">
                    <i class="fas fa-sign-in-alt me-1"></i>
                    Admin Login
                </a>
                {% endif %}
            </div>
        </div>
    </nav>

    <div class="main-content">
        <div class="main-container">
            <div class="hero-card">
                <h1><i class="fas fa-vote-yea me-3"></i>Vote For Me</h1>
                <p class="subtitle">Create voting sessions in seconds</p>
                
                <div class="quick-start">
                    <h3><i class="fas fa-rocket me-2"></i>How it works</h3>
                    <div class="step">
                        <span class="step-number">1</span>
                        <span>Create your voting session with items to vote on</span>
                    </div>
                    <div class="step">
                        <span class="step-number">2</span>
                        <span>Add participants and send them unique voting links</span>
                    </div>
                    <div class="step">
                        <span class="step-number">3</span>
                        <span>Watch results update in real-time</span>
                    </div>
                </div>
                
                <div class="create-form">
                    <h3><i class="fas fa-plus-circle me-2"></i>Create New Session</h3>
                    
                    <!-- Session Title Section -->
                    <div class="form-section">
                        <div class="section-title">
                            <i class="fas fa-info-circle me-2"></i>Session Details
                        </div>
                        <div class="form-floating">
                            <input type="text" class="form-control" id="session-title" placeholder="Session Title" maxlength="100">
                            <label for="session-title">Session Title</label>
                        </div>
                    </div>
                    
                    <!-- Voting Configuration Section -->
                    <div class="form-section">
                        <div class="section-title">
                            <i class="fas fa-cog me-2"></i>Voting Configuration
                        </div>
                        <div class="voting-settings">
                            <!-- Votes per participant -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <select class="form-select" id="votes-per-participant">
                                            <option value="3">3 votes</option>
                                            <option value="5">5 votes</option>
                                            <option value="10" selected>10 votes</option>
                                            <option value="15">15 votes</option>
                                            <option value="20">20 votes</option>
                                            <option value="25">25 votes</option>
                                            <option value="50">50 votes</option>
                                        </select>
                                        <label for="votes-per-participant">Votes per participant</label>
                                    </div>
                                </div>
                                <div class="col-md-6 d-flex align-items-center">
                                    <div class="setting-item w-100">
                                        <div class="setting-label">
                                            <div class="form-check form-switch mb-0">
                                                <input class="form-check-input" type="checkbox" id="anonymous-voting" checked>
                                                <label class="form-check-label" for="anonymous-voting">
                                                    <i class="fas fa-user-secret me-2"></i>Anonymous
                                                </label>
                                            </div>
                                        </div>
                                        <button type="button" class="btn p-0 ms-2" style="background: none; border: none; color: rgba(255,255,255,0.7); font-size: 1rem;" 
                                                data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true"
                                                data-bs-title="<strong>🔒 Anonymous:</strong> Individual votes hidden in results (recommended for privacy)<br><strong>👁️ Non-Anonymous:</strong> Shows participant emails & individual vote breakdowns">
                                            <i class="fas fa-question-circle"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="createSession()" class="btn btn-primary-custom" id="createBtn">
                        <i class="fas fa-rocket me-2"></i>Create Session
                    </button>
                    <div class="error-message" id="error-message"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/shared.js"></script>
    <script>
        async function showMySessions() {
            // Show loading modal first
            showMySessionsLoadingModal();
            
            try {
                const response = await fetch('/api/my-sessions');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                // Remove loading modal
                const loadingModal = document.getElementById('mySessionsLoadingModal');
                if (loadingModal) {
                    const bsModal = bootstrap.Modal.getInstance(loadingModal);
                    if (bsModal) bsModal.hide();
                    setTimeout(() => loadingModal.remove(), 300);
                }
                
                if (result.sessions && result.sessions.length > 0) {
                    // Remove duplicates based on session ID (just in case)
                    const uniqueSessions = result.sessions.filter((session, index, arr) => 
                        arr.findIndex(s => s.id === session.id) === index
                    );
                    
                    let sessionsList = `
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 class="mb-0"><i class="fas fa-list me-2"></i>My Sessions</h4>
                            <span class="badge bg-primary">${uniqueSessions.length} session${uniqueSessions.length !== 1 ? 's' : ''}</span>
                        </div>
                        <div class="list-group">
                    `;
                    
                    uniqueSessions.forEach(session => {
                        const statusIcon = session.status === 'active' ? 'fa-play text-success' : 
                                         session.status === 'completed' ? 'fa-check text-secondary' : 'fa-edit text-warning';
                        
                        const createdDate = new Date(session.created).toLocaleDateString();
                        const timeAgo = getTimeAgo(session.created);
                        
                        sessionsList += `
                            <a href="/manage/${session.id}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-start">
                                <div class="ms-2 me-auto">
                                    <div class="fw-bold">${escapeHtml(session.title)}</div>
                                    <small class="text-muted">
                                        <i class="fas ${statusIcon} me-1"></i>${session.status.charAt(0).toUpperCase() + session.status.slice(1)} • 
                                        ${session.participants_count} participants • ${session.items_count} items
                                    </small>
                                    <br>
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>Created ${timeAgo} (${createdDate})
                                    </small>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted">
                                        <i class="fas fa-arrow-right"></i>
                                    </small>
                                </div>
                            </a>
                        `;
                    });
                    
                    sessionsList += '</div>';
                    
                    showMySessionsModal(sessionsList);
                } else {
                    // No sessions found
                    showMySessionsEmptyState();
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
                // Remove loading modal
                const loadingModal = document.getElementById('mySessionsLoadingModal');
                if (loadingModal) {
                    const bsModal = bootstrap.Modal.getInstance(loadingModal);
                    if (bsModal) bsModal.hide();
                    setTimeout(() => loadingModal.remove(), 300);
                }
                showMySessionsErrorState(error.message);
            }
        }

        function showMySessionsLoadingModal() {
            // Properly cleanup any existing loading modal
            cleanupExistingModal('mySessionsLoadingModal');
            
            const loadingModalHtml = `
                <div class="modal fade" id="mySessionsLoadingModal" tabindex="-1" data-bs-backdrop="static">
                    <div class="modal-dialog modal-sm modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-body text-center py-4">
                                <div class="spinner-border text-primary mb-3" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <h6>Loading Your Sessions...</h6>
                                <small class="text-muted">Please wait</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', loadingModalHtml);
            const modal = new bootstrap.Modal(document.getElementById('mySessionsLoadingModal'));
            modal.show();
        }

        function showMySessionsModal(sessionsList) {
            const modalHtml = `
                <div class="modal fade" id="mySessionsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="fas fa-user me-2"></i>My Sessions</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                ${sessionsList}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="document.getElementById('session-title').focus(); const modal = bootstrap.Modal.getInstance(document.getElementById('mySessionsModal')); modal.hide();">
                                    <i class="fas fa-plus me-2"></i>Create New Session
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Properly dispose of existing modal if any
            cleanupExistingModal('mySessionsModal');
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Create modal instance
            const modal = new bootstrap.Modal(document.getElementById('mySessionsModal'));
            
            // Add cleanup on hide
            document.getElementById('mySessionsModal').addEventListener('hidden.bs.modal', function() {
                cleanupExistingModal('mySessionsModal');
            }, { once: true });
            
            // Show modal
            modal.show();
        }

        function cleanupExistingModal(modalId) {
            const existingModal = document.getElementById(modalId);
            if (existingModal) {
                // Get Bootstrap modal instance
                const bsModalInstance = bootstrap.Modal.getInstance(existingModal);
                if (bsModalInstance) {
                    // Properly dispose of Bootstrap modal instance
                    bsModalInstance.dispose();
                }
                // Remove DOM element
                existingModal.remove();
            }
            
            // Clean up any lingering backdrop elements
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            
            // Ensure body classes are cleaned up
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        }

        function showMySessionsEmptyState() {
            const emptyStateHtml = `
                <div class="text-center py-5">
                    <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                    <h4>No Sessions Yet</h4>
                    <p class="text-muted mb-4">You haven't created any sessions yet.<br>Create your first session to get started!</p>
                </div>
            `;
            showMySessionsModal(emptyStateHtml);
        }

        function showMySessionsErrorState(errorMessage) {
            const errorStateHtml = `
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-4x text-warning mb-3"></i>
                    <h4>Unable to Load Sessions</h4>
                    <p class="text-muted mb-4">There was a problem loading your sessions:<br><small class="text-danger">${escapeHtml(errorMessage)}</small></p>
                    <div class="d-grid gap-2 d-md-block">
                        <button class="btn btn-outline-primary" onclick="showMySessions()">
                            <i class="fas fa-redo me-2"></i>Try Again
                        </button>
                        <button class="btn btn-primary" onclick="document.getElementById('session-title').focus(); const modal = bootstrap.Modal.getInstance(document.getElementById('mySessionsModal')); modal.hide();">
                            <i class="fas fa-plus me-2"></i>Create New Session
                        </button>
                    </div>
                </div>
            `;
            showMySessionsModal(errorStateHtml);
        }

        function getTimeAgo(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffDays > 7) {
                return `${Math.floor(diffDays / 7)} week${Math.floor(diffDays / 7) !== 1 ? 's' : ''} ago`;
            } else if (diffDays > 0) {
                return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
            } else if (diffHours > 0) {
                return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
            } else {
                return 'Less than an hour ago';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize tooltips
        document.addEventListener('DOMContentLoaded', function() {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });

        // Update tooltip content based on anonymous checkbox (tooltip content is now static)

        async function createSession() {
            const title = document.getElementById('session-title').value.trim();
            const votesPerParticipant = parseInt(document.getElementById('votes-per-participant').value);
            const anonymous = document.getElementById('anonymous-voting').checked;
            const btn = document.getElementById('createBtn');
            const errorDiv = document.getElementById('error-message');
            
            if (!title) {
                showError('Please enter a session title');
                return;
            }
            
            // Show loading state
            btn.classList.add('btn-loading');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating Session...';
            errorDiv.style.display = 'none';
            
            try {
                const response = await fetch('/api/sessions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        title,
                        votes_per_participant: votesPerParticipant,
                        anonymous
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Success - redirect to management page for the new session
                    window.location.href = `/manage/${result.session.id}`;
                } else {
                    showError(result.error || 'Failed to create session');
                }
            } catch (error) {
                showError('Network error. Please try again.');
            } finally {
                // Reset button state
                btn.classList.remove('btn-loading');
                btn.innerHTML = '<i class="fas fa-rocket me-2"></i>Create Session';
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // Handle Enter key press
        document.getElementById('session-title').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                createSession();
            }
        });
        
        // Navigation hide-on-scroll functionality (improved)
        let lastScrollTop = 0;
        let scrollTimeout;
        const navigation = document.getElementById('navigation');
        
        function handleNavVisibility() {
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            
            // Clear existing timeout
            if (scrollTimeout) {
                clearTimeout(scrollTimeout);
            }
            
            // Show navigation when scrolling up or at top
            if (scrollTop < lastScrollTop || scrollTop <= 50) {
                navigation.classList.remove('nav-hidden');
            } else if (scrollTop > 100) {
                // Hide navigation when scrolling down past 100px
                navigation.classList.add('nav-hidden');
            }
            
            lastScrollTop = scrollTop;
            
            // Always show navigation after user stops scrolling for 2 seconds
            scrollTimeout = setTimeout(() => {
                navigation.classList.remove('nav-hidden');
            }, 2000);
        }
        
        // Add scroll listener with throttling
        let ticking = false;
        window.addEventListener('scroll', function() {
            if (!ticking) {
                requestAnimationFrame(function() {
                    handleNavVisibility();
                    ticking = false;
                });
                ticking = true;
            }
        }, { passive: true });
        
        // Show navigation on mouse move near top
        document.addEventListener('mousemove', function(e) {
            if (e.clientY <= 100) {
                navigation.classList.remove('nav-hidden');
            }
        });
    </script>
</body>
</html>
